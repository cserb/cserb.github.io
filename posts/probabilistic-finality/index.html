<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Build your first blockchain from scratch (#1 Probabilistic Finality) - cșerb</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Build your first blockchain from scratch (#1 Probabilistic Finality)" />
<meta property="og:description" content="This is the first part in a series that will teach you how to build a full featured blockchain from scratch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cserb.net/posts/probabilistic-finality/" />
<meta property="article:published_time" content="2019-10-31T11:49:12+01:00" />
<meta property="article:modified_time" content="2019-10-31T11:49:12+01:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Build your first blockchain from scratch (#1 Probabilistic Finality)"/>
<meta name="twitter:description" content="This is the first part in a series that will teach you how to build a full featured blockchain from scratch."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://cserb.net/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cserb.net/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://cserb.net/css/custom.css" />
	

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<script src="https://cserb.net/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title"><a href="/">cșerb</a></h1>
	<div class="site-description"><h2>cserb.net — blockchain, crystal-lang, startups</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/cserb" title="Github"><i data-feather="github"></i></a><a href="https://twitter.com/cerbivore" title="Twitter"><i data-feather="twitter"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">Posts</a>
			</li>
			
			<li>
				<a href="https://github.com/cocol-project">Cocol Project</a>
			</li>
			
			<li>
				<a href="https://represent.io/cserb">CV</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Build your first blockchain from scratch (#1 Probabilistic Finality)</h1>
			<div class="meta">Posted at &mdash; Oct 31, 2019</div>
		</div>

		<div class="markdown">
			

<h3 id="this-is-the-first-part-in-a-series-that-will-teach-you-how-to-build-a-full-featured-blockchain-from-scratch">This is the first part in a series that will teach you how to build a full featured blockchain from scratch.</h3>

<h2 id="introduction">Introduction</h2>

<p>I won&rsquo;t be able to cover all aspects in detail, neither is it intended. You should rather make yourself familiar with the high level concept of how a blockchain works. As kind of a reference point you should be familiar with Andreas Antonopoulos&rsquo; book <a href="https://github.com/bitcoinbook/bitcoinbook">Mastering Bitcoin</a>, which if needed covers quite some detail.</p>

<p>Understanding how e.g. Bitcoin works doesn&rsquo;t necessarily give you the insight on how to actually build your own blockchain. So I will try to focus during the series solely on the aspects of engineering and will reference to videos, blog articles or to <code>Mastering Bitcoin</code> when it might be of help.</p>

<p>Think of the series as a walkthrough. You can follow along and end up with your own blockchain, but you need to do your homework to fully grasp the non-technical side of blockchain.</p>

<p>Let&rsquo;s start with one of the hardest parts of blockchain: Probabilistic Finality. It&rsquo;s at the core of the consensus mechanism and depends on multiple concepts that come together to achieve probabilistic finality.</p>

<h2 id="1-probabilistic-finality">1. Probabilistic Finality</h2>

<p><em>Finality</em> is the agreement that a valid transaction between <em>A</em> and <em>B</em> has been executed and can&rsquo;t be reverted. If <em>A</em> uses a Visa card to buy coffee from <em>B</em>, <em>B</em> trusts its bank that the agreement the bank made with Visa will ensure a finalized transaction.</p>

<p>In a decentralized network the trust is given to the majority of the participants (nodes in our case) and we find out what is considered finalized by looking at how the majority sees the state of the transaction.</p>

<p>Learn more about it here: <a href="https://blog.ethereum.org/2016/05/09/on-settlement-finality/">On Settlement Finality</a>, <a href="https://www.youtube.com/watch?v=efyiPhZvqOA">Finality in Blockchain Consensus [video]</a></p>

<p>So how do we &ldquo;implement finality&rdquo; in our blockchain?</p>

<p>Imagine you are a <em>node</em> within our blockchain network. Your node is maintaining a copy of the blockchain data and at the moment it&rsquo;s waiting for the next block to be propagated. Current block is <code>#3000</code> and <code>#3001</code> should arrive soon. But because there are multiple miners there is a chance you will receive 2 versions of <code>#3001</code>. Which one to choose?</p>

<p><img src="https://thepracticaldev.s3.amazonaws.com/i/0hobbj89lkrwdy7gaeua.png" alt="Alt Text" /></p>

<p>The example above shows how the current tip of the blockchain could look like after we received 2 versions of block <code>#3001</code>. In the end we don&rsquo;t choose any of the propagated <code>#3001</code> blocks, but wait for several more consecutive blocks to make a decision.</p>

<p>To understand why waiting makes sense we also need to understand <em>Proof of Work</em> (PoW).</p>

<h2 id="2-proof-of-work-pow">2. Proof of Work (PoW)</h2>

<p>PoW is the algorithm that makes mining possible. It is usually explained by what
 it does:</p>

<blockquote>
<p>In the simplest terms, mining is the process of hashing the block header repeatedly, changing one parameter, until the resulting hash matches a specific target. The hash function’s result cannot be determined in advance, nor can a pattern be created that will produce a specific hash value.
(from Mastering Bitcoin)</p>
</blockquote>

<p>But more than by what it does, we need to understand what it&rsquo;s used for. The game theoretic aspect is one of its use cases, that we will cover later. It is important for finality, but not so much for the engineering part.</p>

<p>PoW is also used for <em>randomness</em> and we are very much interested in that part, so that we can implement finality.</p>

<p>Imagine 3 miners embark on the mission to mine the next block. All 3 look for a different solution since the block header they constructed is unique and because of that the time it takes to mine is more or less random.</p>

<p>Another way to think about mining is imagining a race, where each participant has a different predetermined but unknown finish line. Thus the time it takes to reach the finish line is unpredictable and random.</p>

<h3 id="2-1-randomness">2.1 Randomness</h3>

<p>Let&rsquo;s find out what would happen if we build a blockchain without PoW. If every node in the network would have the ability to create a block instantly, it would look like in the example below</p>

<p><img src="https://thepracticaldev.s3.amazonaws.com/i/2f330n5qeruall6jk3d6.png" alt="Alt Text" /></p>

<p>Multiple miners will create a block at the same time and broadcast it to the network. It would be impossible to reach consensus, if for each round <code>T</code> all blocks of <code>Tn</code> would be propagated at the same time.</p>

<p>It can still happen that different miners find the next block at the same time (see example below), but at some point the chances that <em>only one</em> miner will find the next block are very high (because of the randomness in PoW) and as a consequence we can consider the chain of <code>B1.1-&gt; B2.1-&gt;B3.1-&gt;B4.1-&gt;B5.1</code> as the longest one. Also we can decide to finalize block <code>B2.1</code> if we want.</p>

<p><img src="https://thepracticaldev.s3.amazonaws.com/i/macwc1kyewgfb5cl5n05.png" alt="Alt Text" /></p>

<p>Note: Block 4.2 has been abandoned mid-mining because it just wasn&rsquo;t fast enough. So there is no reason to waste more energy on it.</p>

<h2 id="3-conclusion">3. Conclusion</h2>

<p>In order to reach probabilistic finality we need to make our nodes agree on the longest chain and the mechanism that enables this is PoW. There is much more to PoW, but for now we don&rsquo;t need to cover that.</p>

<h2 id="4-next-up">4. Next Up</h2>

<p>In the next article will find out how a Directed Acyclic Graph works and why we need it to find the longest chain.</p>

<p><a href="https://cserb.net/posts/dag/">Part #2: DAGs</a></p>

		</div>

		<div class="post-tags">
			
				
			
		</div></div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © 2019 Cristian Serb |  <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>

<script>feather.replace()</script>
</body>
</html>
